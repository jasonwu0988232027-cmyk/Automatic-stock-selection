import streamlit as st
import yfinance as yf
import pandas as pd
import pandas_ta as ta
import time

# --- ç¶²é é…ç½® ---
st.set_page_config(page_title="AI å…¨ç”¢æ¥­é¾é ­é¸è‚¡å™¨", layout="wide")

# --- 1. å·¨é‡è‚¡ç¥¨æ•¸æ“šåº« (æ¶µè“‹å°è‚¡å„è¡Œæ¥­å‰ 10 åé¾é ­ + ETF) ---
TW_STOCKS = [
    # åŠå°é«”/ICè¨­è¨ˆ
    "2330.TW", "2454.TW", "2303.TW", "3711.TW", "2379.TW", "3034.TW", "2337.TW", "2408.TW", "6770.TW", "3532.TW",
    # é›»å­ä»£å·¥/è¨­å‚™
    "2317.TW", "2308.TW", "2382.TW", "2357.TW", "2324.TW", "3231.TW", "2356.TW", "4938.TW", "2395.TW", "3008.TW",
    # é‡‘èä¿éšª
    "2881.TW", "2882.TW", "2886.TW", "2891.TW", "2884.TW", "5880.TW", "2880.TW", "2885.TW", "2892.TW", "2883.TW",
    # èˆªé‹/ç‰©æµ
    "2603.TW", "2609.TW", "2615.TW", "2618.TW", "2610.TW", "2605.TW", "5608.TW",
    # å¡‘åŒ–/æ²¹æ°£
    "1301.TW", "1303.TW", "1326.TW", "6505.TW", "1304.TW",
    # é‹¼éµ/æ°´æ³¥/å»ºæ
    "2002.TW", "2014.TW", "1101.TW", "1102.TW", "2542.TW", "1802.TW", "2501.TW",
    # é£Ÿå“/è§€å…‰/ç™¾è²¨
    "1216.TW", "2912.TW", "2727.TW", "2707.TW", "9943.TW", "1227.TW", "2207.TW",
    # ç”ŸæŠ€/é†«ç™‚
    "1760.TW", "4147.TW", "6472.TW", "1752.TW", "1795.TW",
    # é›»ä¿¡/å…¬ç”¨äº‹æ¥­
    "2412.TW", "3045.TW", "4904.TW", "8926.TW",
    # æŒ‡æ•¸ ETF èˆ‡ é¿éšªæ¨™çš„
    "0050.TW", "006208.TW", "0056.TW", "00878.TW", "00919.TW", 
    "00713.TW", "00929.TW", "00940.TW", "00632R.TW", "00631L.TW"
]

US_STOCKS = ["AAPL", "NVDA", "TSLA", "AMD", "MSFT", "GOOGL", "META", "AMZN"]

# --- 2. å´é‚Šæ¬„æ§åˆ¶é¢æ¿ ---
st.sidebar.title("ğŸ› ï¸ AI ç­–ç•¥è¨­å®š")
market_choice = st.sidebar.selectbox("1. æƒæå¸‚å ´", ["TW", "BOTH", "US"])
top_n_input = st.sidebar.text_input("2. æ¨è–¦åé¡ (ç•™ç©ºå‰‡è‡ªå‹•ç¯©é¸)", "")
total_budget = st.sidebar.number_input("3. æŠ•è³‡ç¸½é ç®—", value=1000000, step=100000)
auto_threshold = st.sidebar.slider("4. è‡ªå‹•æ¨¡å¼é–€æª» (åˆ†)", 30, 100, 50)
stop_loss_pct = st.sidebar.slider("5. åœæåŸºæº– (%)", 1, 15, 7) / 100

# --- 3. æ ¸å¿ƒåˆ†æå¼•æ“ (å«å¿«å–æ©Ÿåˆ¶) ---
@st.cache_data(ttl=3600)
def analyze_stock(ticker):
    try:
        df = yf.download(ticker, period="100d", interval="1d", progress=False, auto_adjust=True)
        if df.empty or len(df) < 30: return None
        
        # ä¿®æ­£æ–°ç‰ˆ yfinance å¤šé‡ç´¢å¼•å•é¡Œ
        if isinstance(df.columns, pd.MultiIndex):
            df.columns = df.columns.get_level_values(0)

        # æŠ€è¡“æŒ‡æ¨™è¨ˆç®—
        df['RSI'] = ta.rsi(df['Close'], length=14)
        df['MA5'] = ta.sma(df['Close'], length=5)
        df['MA10'] = ta.sma(df['Close'], length=10)

        last = df.iloc[-1]
        prev = df.iloc[-2]
        curr_p = float(last['Close'])
        prev_p = float(prev['Close'])
        change_pct = ((curr_p - prev_p) / prev_p) * 100

        # --- è©•åˆ†ç³»çµ± ---
        score = 0
        reasons = []

        if float(last['RSI']) < 20:
            score += 40
            reasons.append("RSIè¶…è³£")
        if float(prev['MA5']) < float(prev['MA10']) and float(last['MA5']) > float(last['MA10']):
            score += 30
            reasons.append("5/10MAé‡‘å‰")
        
        limit = 9.5 if ".TW" in ticker else 7.0
        if abs(change_pct) >= limit:
            score += 20
            reasons.append(f"æ³¢å‹•({round(change_pct,1)}%)")
        if float(last['Volume']) > df['Volume'].mean() * 2:
            score += 10
            reasons.append("æˆäº¤çˆ†é‡")

        if score > 0:
            return {
                "ä»£ç¢¼": ticker,
                "è©•åˆ†": score,
                "ç¾åƒ¹": round(curr_p, 2),
                "æ¼²è·Œå¹…": f"{round(change_pct, 2)}%",
                "è§¸ç™¼è¨Šè™Ÿ": " + ".join(reasons),
                "raw_score": score
            }
    except Exception:
        return None

# --- 4. ä¸»ç¨‹å¼åŸ·è¡Œä»‹é¢ ---
st.title("ğŸ† AI å…¨ç”¢æ¥­é¾é ­é¸è‚¡åŠ©æ‰‹")
st.markdown(f"**ç›£æ§ä¸­ï¼š** å°è‚¡å„ç”¢æ¥­é¾é ­åŠ ETF å…± {len(TW_STOCKS)} æª”ï¼Œç¾è‚¡ç§‘æŠ€æ¬Šå€¼ {len(US_STOCKS)} æª”ã€‚")

if st.button("ğŸš€ åŸ·è¡Œå…¨è‡ªå‹•ç”¢æ¥­æƒæ"):
    target_list = TW_STOCKS if market_choice == "TW" else (US_STOCKS if market_choice == "US" else TW_STOCKS + US_STOCKS)
    
    results = []
    progress_bar = st.progress(0)
    status_text = st.empty()

    for i, ticker in enumerate(target_list):
        status_text.text(f"ğŸ” æ­£åœ¨æƒæè¡Œæ¥­é¾é ­: {ticker} ({i+1}/{len(target_list)})")
        res = analyze_stock(ticker)
        if res:
            results.append(res)
        progress_bar.progress((i + 1) / len(target_list))

    status_text.success("âœ… å…¨ç”¢æ¥­æƒæå®Œæˆï¼")

    if results:
        # æ’åºèˆ‡ç¯©é¸
        df_res = pd.DataFrame(results).sort_values("raw_score", ascending=False)
        top_n = int(top_n_input) if top_n_input.isdigit() else None
        
        if top_n:
            final_df = df_res.head(top_n).copy()
        else:
            final_df = df_res[df_res['raw_score'] >= auto_threshold].copy()
            if final_df.empty: final_df = df_res.head(1).copy()

        # 5. è¨ˆç®—éƒ¨ä½é…ç½®
        num_picks = len(final_df)
        allocation = total_budget / num_picks
        
        final_df['å»ºè­°è²·å…¥æ•¸é‡'] = final_df.apply(
            lambda x: f"{int(allocation/x['ç¾åƒ¹']//1000)} å¼µ" if ".TW" in x['ä»£ç¢¼'] else f"{int(allocation/x['ç¾åƒ¹'])} è‚¡", 
            axis=1
        )
        final_df['åœæåƒè€ƒåƒ¹'] = (final_df['ç¾åƒ¹'] * (1 - stop_loss_pct)).round(2)

        # --- ç‰¹æ®Šæé†’ï¼šåå‘ 50 ---
        if "00632R.TW" in final_df['ä»£ç¢¼'].values:
            st.error("ğŸš¨ **å¸‚å ´è­¦è¨Š**ï¼šAI æ¨è–¦äº†ã€å…ƒå¤§å°ç£50å1ã€ï¼é€™ä»£è¡¨å¤§ç›¤å¤šæ•¸é¾é ­è‚¡æŠ€è¡“æŒ‡æ¨™è½‰å¼±ï¼Œè«‹åš´æ ¼åŸ·è¡Œé¿éšªæˆ–åœæã€‚")

        # é¡¯ç¤ºçµæœ
        st.subheader(f"ğŸ¯ AI æ¨è–¦æ¸…å–® ({'æ‰‹å‹•' if top_n else 'è‡ªå‹•'}æ¨¡å¼)")
        st.table(final_df.drop(columns=['raw_score']))
        st.balloons()
    else:
        st.warning("ä»Šæ—¥å¸‚å ´æŒ‡æ¨™æœªè§¸ç™¼ä»»ä½•æ¨è–¦è¨Šè™Ÿã€‚")
